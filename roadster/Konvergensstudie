import numpy as np
import roadster as rsd
import matplotlib.pyplot as plt
from scipy.integrate import quad 

anna_dist, anna_speed = rsd.load_route('speed_anna.npz')
elsa_dist, elsa_speed = rsd.load_route('speed_elsa.npz')

da = anna_dist[-1]   # Annas sträcka
de = elsa_dist[-1] # Elsas sträcka

steg = 20
n = 100

h_anna = np.zeros(steg)
h_elsa = np.zeros(steg)
fela = np.zeros(steg)
fele = np.zeros(steg)

for i in range(steg):
    #Anna
    Tha  = rsd.time_to_destination(da, 'speed_anna.npz', n)
    T2ha = rsd.time_to_destination(da, 'speed_anna.npz', n // 2)
    fela[i] = np.abs((Tha - T2ha) / 3) # Tredjedelsregeln
    #Elsa
    The  = rsd.time_to_destination(de, 'speed_elsa.npz', n)
    T2he = rsd.time_to_destination(de, 'speed_elsa.npz', n // 2)
    fele[i] = np.abs((The - T2he) / 3)

    h_anna[i] = da / n
    h_elsa[i] = de / n
    n = 2 * n

#plot av konvergens med hjälplinjer


plt.figure(figsize=(10, 6))
plt.loglog(h_anna, fela, 'o-', label='Anna (estimerat fel)')
plt.loglog(h_elsa, fele, 's-', label='Elsa (estimerat fel)')


# Vi antar p=2 för trapetsregeln. Vi skapar en referenslinje C * h^p.
# Vi väljer C så att linjen hamnar i närheten av våra mätdata för att lätt kunna jämföra lutningen.
p = 2
C = fela[0] / (h_anna[0]**p) 
h_ref = h_anna
y_ref = C * (h_ref**p)

plt.loglog(h_ref, y_ref, '--', color='gray', label=f'Referenslinje O(h^{p})')

# (Valfritt) Lägg till en linje för O(h^1) för att se skillnaden i lutning
# y_ref_p1 = (fela[0] / h[0]**1) * (h_ref**1)
# plt.loglog(h_ref, y_ref_p1, ':', color='red', label='Referenslinje O(h^1)')

plt.xlabel('Steglängd h')
plt.ylabel('Uppskattat integrationsfel')
plt.title('Konvergensanalys med hjälplinje för noggrannhetsordning')
plt.grid(True, which='both', linestyle='--', alpha=0.5)
plt.legend()
plt.show()