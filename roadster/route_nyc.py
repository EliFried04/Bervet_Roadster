from scipy import interpolate
import numpy as np 
from pchip_2d import pchip_2d

N_data_t = 25
data_t = np.linspace(0, 24, N_data_t)
N_data_x = 30
data_x = np.linspace(0, 60, N_data_x)

nyc_velocity = np.array([[63.65,64.41,65.17,65.93,66.69,56.28,44.73,21.62,18.28,14.94,12.96,14.91,16.85,18.80,48.45,28.11,19.11,20.14,21.48,22.83,29.91,50.65,49.52,48.39,47.26],[63.65,64.41,65.17,65.93,66.69,56.28,44.73,21.62,18.28,14.94,12.96,14.91,16.85,18.80,48.45,28.11,19.11,20.14,21.48,22.83,29.91,50.65,49.52,48.39,47.26],[63.65,64.41,65.17,65.93,66.69,56.28,44.73,21.62,18.28,14.94,12.96,14.91,16.85,18.80,48.45,28.11,19.11,20.14,21.48,22.83,29.91,50.65,49.52,48.39,47.26],[56.01,57.61,59.22,60.83,62.44,64.05,65.66,60.06,52.38,44.71,51.62,52.61,53.60,53.00,50.80,48.60,24.11,24.38,27.03,29.69,40.97,45.47,49.98,54.48,58.98],[56.01,57.61,59.22,60.83,62.44,64.05,65.66,60.06,52.38,44.71,51.62,52.61,53.60,53.00,50.80,48.60,24.11,24.38,27.03,29.69,40.97,45.47,49.98,54.48,58.98],[56.01,57.61,59.22,60.83,62.44,64.05,65.66,60.06,52.38,44.71,51.62,52.61,53.60,53.00,50.80,48.60,24.11,24.38,27.03,29.69,40.97,45.47,49.98,54.48,58.98],[93.02,92.03,91.04,90.05,89.06,88.07,87.08,48.23,32.06,42.94,83.27,82.36,81.45,80.54,79.63,78.72,24.84,36.84,40.37,61.51,80.70,82.61,84.51,86.42,88.33],[93.02,92.03,91.04,90.05,89.06,88.07,87.08,48.23,32.06,42.94,83.27,82.36,81.45,80.54,79.63,78.72,24.84,36.84,40.37,61.51,80.70,82.61,84.51,86.42,88.33],[93.02,92.03,91.04,90.05,89.06,88.07,87.08,48.23,32.06,42.94,83.27,82.36,81.45,80.54,79.63,78.72,24.84,36.84,40.37,61.51,80.70,82.61,84.51,86.42,88.33],[93.02,92.03,91.04,90.05,89.06,88.07,87.08,48.23,32.06,42.94,83.27,82.36,81.45,80.54,79.63,78.72,24.84,36.84,40.37,61.51,80.70,82.61,84.51,86.42,88.33],[93.02,92.03,91.04,90.05,89.06,88.07,87.08,48.23,32.06,42.94,83.27,82.36,81.45,80.54,79.63,78.72,24.84,36.84,40.37,61.51,80.70,82.61,84.51,86.42,88.33],[89.19,88.63,88.07,87.51,86.95,86.39,85.82,85.26,72.68,74.12,85.75,85.60,85.45,85.30,85.15,85.01,84.78,86.53,88.28,87.70,88.49,89.28,90.07,90.87,91.66],[89.19,88.63,88.07,87.51,86.95,86.39,85.82,85.26,72.68,74.12,85.75,85.60,85.45,85.30,85.15,85.01,84.78,86.53,88.28,87.70,88.49,89.28,90.07,90.87,91.66],[89.19,88.63,88.07,87.51,86.95,86.39,85.82,85.26,72.68,74.12,85.75,85.60,85.45,85.30,85.15,85.01,84.78,86.53,88.28,87.70,88.49,89.28,90.07,90.87,91.66],[89.19,88.63,88.07,87.51,86.95,86.39,85.82,85.26,72.68,74.12,85.75,85.60,85.45,85.30,85.15,85.01,84.78,86.53,88.28,87.70,88.49,89.28,90.07,90.87,91.66],[89.19,88.63,88.07,87.51,86.95,86.39,85.82,85.26,72.68,74.12,85.75,85.60,85.45,85.30,85.15,85.01,84.78,86.53,88.28,87.70,88.49,89.28,90.07,90.87,91.66],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[107.34,106.20,105.07,103.94,102.81,101.68,100.55,99.41,98.28,97.15,96.02,94.89,93.75,101.52,101.10,100.67,100.25,99.83,99.40,71.85,98.35,99.54,100.73,101.92,103.11],[95.75,96.07,96.39,96.71,97.03,97.35,97.67,90.93,87.00,83.08,79.16,75.24,71.31,85.97,83.07,80.17,70.54,70.78,71.02,55.75,81.84,86.74,89.43,92.13,94.82],[95.75,96.07,96.39,96.71,97.03,97.35,97.67,90.93,87.00,83.08,79.16,75.24,71.31,85.97,83.07,80.17,70.54,70.78,71.02,55.75,81.84,86.74,89.43,92.13,94.82],[95.75,96.07,96.39,96.71,97.03,97.35,97.67,90.93,87.00,83.08,79.16,75.24,71.31,85.97,83.07,80.17,70.54,70.78,71.02,55.75,81.84,86.74,89.43,92.13,94.82],[95.75,96.07,96.39,96.71,97.03,97.35,97.67,90.93,87.00,83.08,79.16,75.24,71.31,85.97,83.07,80.17,70.54,70.78,71.02,55.75,81.84,86.74,89.43,92.13,94.82],[95.75,96.07,96.39,96.71,97.03,97.35,97.67,90.93,87.00,83.08,79.16,75.24,71.31,85.97,83.07,80.17,70.54,70.78,71.02,55.75,81.84,86.74,89.43,92.13,94.82],[92.51,92.75,92.98,93.21,93.45,93.68,93.91,38.26,20.18,30.66,44.79,52.12,59.44,75.90,77.95,79.99,19.20,21.49,17.97,49.28,84.90,86.84,88.79,90.73,92.67],[92.51,92.75,92.98,93.21,93.45,93.68,93.91,38.26,20.18,30.66,44.79,52.12,59.44,75.90,77.95,79.99,19.20,21.49,17.97,49.28,84.90,86.84,88.79,90.73,92.67],[92.51,92.75,92.98,93.21,93.45,93.68,93.91,38.26,20.18,30.66,44.79,52.12,59.44,75.90,77.95,79.99,19.20,21.49,17.97,49.28,84.90,86.84,88.79,90.73,92.67]])

def route_nyc(t,x):
    """
    This function models traffic data along a given route.
    The function returns the expected speed at a given time t 
    and position x along the route. The model is based on 
    historical traffic data on a number of road links provided 
    by NYC OpenData.
    
    Parameters:
      0 <= t <= 24 (hour of day)
      0 <= x <= 60 (km from start of route)
    Returns:
      Speed in km/h    
    """
    return pchip_2d(data_t,data_x,nyc_velocity,t,x)-10

### PART 4A ###
def nyc_route_traveler_euler(t0, h):
    """
    Simulerar en resa längs rutten med Eulers metod.
    Startar vid tid t0 och position x=0 och avslutas när x=60 km.

    Returnerar:
      time_h     : array med tider (h)
      distance_km: array med positioner (km)
      speed_kmph : array med hastigheter (km/h)
    """
    t = float(t0)
    x = 0.0

    time_list = [float(t)]
    dist_list = [float(x)]

    # Hjälpfunktion: säkerställ att route_nyc ger ett ENKELT skalärt värde
    def _scalar_speed(tt, xx):
        v_raw = route_nyc(tt, xx)
        arr = np.asarray(v_raw)
        if arr.size != 1:
            raise ValueError(f"route_nyc returned non-scalar speed (shape {arr.shape}) for t={tt}, x={xx}")
        return float(arr.item())

    # initiera med en skalär
    speed_list = [_scalar_speed(t, x)]

    # huvudloop
    while x < 60.0:
        v = _scalar_speed(t, x)   # km/h (float)

        if v <= 0:
            # defensiv hantering: om hastigheten blir 0 eller negativ,
            # avsluta för att undvika oändlig loop / division med noll.
            # Detta borde normalt inte hända med given modell.
            # Vi lägger till sista punkt och bryter.
            time_list.append(float(t))
            dist_list.append(float(x))
            speed_list.append(float(v))
            break

        # föreslaget Eulersteg
        x_new = x + h * v
        t_new = t + h

        # Om vi går förbi 60 km → justera sista steget så att x_new == 60
        if x_new > 60.0:
            h_last = (60.0 - x) / v
            t_new = t + h_last
            x_new = 60.0

            time_list.append(float(t_new))
            dist_list.append(float(x_new))
            speed_list.append(_scalar_speed(t_new, x_new))
            break

        # normalt steg: spara skalära värden
        time_list.append(float(t_new))
        dist_list.append(float(x_new))
        speed_list.append(_scalar_speed(t_new, x_new))

        # uppdatera för nästa steg
        t = t_new
        x = x_new

    return np.array(time_list, dtype=float), np.array(dist_list, dtype=float), np.array(speed_list, dtype=float)

    raise NotImplementedError('nyc_route_traveler_euler not implemented yet!')